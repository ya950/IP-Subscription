⚡️ Cloudflare Workers 节点管理系统 v10.7 部署教程📝 项目简介这是一个运行在 Cloudflare Workers 上的无服务器（Serverless）应用。它结合了 KV (用于缓存和会话) 和 R2 (用于存储大文件和配置)，提供了一个强大的 Web 界面来管理、提取、去重和转换各类代理节点 IP。v10.7 更新亮点缓存修复 (Critical): 彻底解决了编辑文件保存后，刷新页面列表消失的问题（通过强制 HTTP 响应头禁用浏览器缓存）。Base64 增强: 修复了部分订阅链接（特别是使用 URL-Safe Base64 编码，即包含 - 和 _ 字符）无法提取 IP 的 bug。逻辑优化: 优化了元数据同步机制，防止 R2 写入成功但索引未更新的情况。🛠 准备工作在开始之前，请确保你拥有一个 Cloudflare 账号。1. 创建 KV Namespace (键值存储)登录 Cloudflare Dashboard。进入 Workers & Pages -> KV。点击 Create a Namespace。名称输入：IP_NODES (建议大写，与代码一致)。点击 Add。2. 创建 R2 Bucket (对象存储)进入 R2 菜单。点击 Create Bucket。名称输入：node-files (或者自定义，但绑定变量名必须是 NODE_FILES)。点击 Create Bucket。注意： R2 有免费额度（每月 10GB 存储，100万次写操作），对于个人使用完全足够。🚀 部署步骤1. 创建 Worker进入 Workers & Pages -> Overview。点击 Create Worker。命名为 node-manager (或你喜欢的名字)。点击 Deploy (先部署一个默认的 Hello World)。点击 Edit code 进入代码编辑器。2. 粘贴代码将你提供的 v10.7 完整代码粘贴到编辑器中的 worker.js 文件中（覆盖原内容）。代码过长，请直接使用你上面提供的完整代码块。3. 配置变量绑定 (最关键的一步)在代码编辑器页面，点击左侧的 Settings (或者部署后去 Worker 的 Settings -> Variables)。你需要添加以下 环境变量 和 绑定：A. 环境变量 (Environment Variables)变量名示例值说明ADMIN_PASSWORDMySecretPass123必填。Web 管理界面的登录密码。TG_BOT_TOKEN123456:ABC-Def...(选填) Telegram 机器人 Token，用于发文件上传。TG_WHITELIST_ID123456789(选填) 你的 TG Chat ID，防止陌生人上传文件。B. KV Namespace Bindings向下滚动到 KV Namespace Bindings。点击 Add binding。Variable name: IP_NODES (必须完全一致)。KV Namespace: 选择你刚才创建的 IP_NODES。C. R2 Bucket Bindings向下滚动到 R2 Bucket Bindings。点击 Add binding。Variable name: NODE_FILES (必须完全一致)。R2 Bucket: 选择你刚才创建的 node-files。4. 部署与配置触发器点击右上角的 Deploy 保存并部署。(可选) 设置 Cron Triggers：如果你希望系统自动更新订阅文件，去 Worker 的 Settings -> Triggers。点击 Add Cron Trigger。设置为每 2 小时或每天执行一次 (例如 0 */2 * * *)。🤖 (可选) 配置 Telegram 机器人如果你配置了 TG_BOT_TOKEN，你需要设置 Webhook 才能让机器人接收文件。在浏览器中访问以下 URL（替换为你自己的信息）：https://api.telegram.org/bot<你的机器人TOKEN>/setWebhook?url=https://<你的WORKER域名>/api/tg_hook
如果返回 Webhook was set，说明配置成功。现在你可以直接把 .txt 或 .csv 的 IP 文件发送给机器人，它会自动上传到系统。🖥 界面功能详解 (图文指引)部署完成后，访问你的 Worker 域名 (例如 https://node-manager.your-name.workers.dev)。1. 登录界面输入你在环境变量 ADMIN_PASSWORD 中设置的密码。2. 主控制台布局界面采用顶部 Tab 导航设计，v10.7 修复了缓存问题，操作更加流畅。🌐 Tab 1: IP 来源 (Sources)这是数据仓库，管理所有基础数据。📂 上传管理: 查看通过网页或 TG 机器人上传的本地文件。支持预览和删除。📡 订阅源: 添加各类机场订阅链接（支持 Base64、Clash、V2Ray 等格式）。v10.7 增强了对 vmess:// 中 URL-Safe Base64 的解析。🔗 API 源: 添加返回纯文本 IP 列表的 API 接口。📝 自定义 IP: 手动粘贴优质 IP 列表。🌐 找资源: 收藏常用的 IP 发布网站。🧪 Tab 2: 提取测试 (Extract)用于临时测试和组合数据。勾选左侧的来源（文件、订阅、API）。点击 🚀 立即提取。系统会自动去重、解析订阅、提取 IP，并在下方显示结果。📂 Tab 3: 文件生成 (Files) - 核心功能这里生成的链接是永久有效的，适合放入 Clash 或 V2Ray 中使用。输入文件名: 例如 best_cf。选择数据源: 勾选需要的 Upload 文件、可编辑文件或订阅源。自动更新: 勾选后，Cron 定时任务会每天自动重新拉取源数据并更新此文件。生成的链接:🔗 Workers链接: 动态读取，速度快。🚀 R2直链: 直接指向存储桶，适合高并发下载。✏️ Tab 4: 可编辑文件 (Editable)这是 v10.7 重点优化的模块。可以创建一个“虚拟文件”，在网页上直接编辑 IP 内容。v10.7 修复: 点击保存后，浏览器不再缓存旧列表，刷新页面立即显示最新修改。用途: 适合维护一个精选的手动 IP 列表，并将其作为 Tab 3 生成文件的“源”。🛠️ Tab 5: 查询工具 (Tools)批量查询: 粘贴一批 IP，系统会调用 Cloudflare 边缘网络查询 IP 的归属地（国家代码）。支持一键保存查询结果为“可编辑文件”。❓ 常见问题排查Q: 为什么保存了“可编辑文件”，刷新页面后文件又变回去了？A: 这是旧版本的 Bug。v10.7 已通过在 handleAdmin 中添加 Cache-Control: no-store 标头修复此问题。请确保你的代码已更新到 v10.7。Q: 某些 Base64 的订阅链接提取出来是乱码或为空？A: 检查订阅链接是否使用了 URL-Safe Base64 (将 + 替换为 -，/ 替换为 _)。v10.7 的 parseSubscription 函数已增加对此类编码的自动替换和 Padding 补全支持。Q: TG 机器人上传失败？A: 1. 检查 TG_FILE_LIMIT (默认 5MB)。 2. 确保你的 Worker 域名没有被墙（Telegram 服务器需要能访问你的 Worker）。 3. 确保执行了 setWebhook 操作。Q: 如何更新到此版本？A: 直接复制 v10.7 的代码，去 Cloudflare Dashboard 编辑 Worker，全选覆盖粘贴，然后点击 Deploy 即可。数据存储在 KV 和 R2 中，更新代码不会丢失数据。
